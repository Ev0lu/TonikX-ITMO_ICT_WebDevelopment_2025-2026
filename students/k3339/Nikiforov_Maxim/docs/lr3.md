# Структура проекта и описание реализации

## Введение

В рамках выполнения лабораторной работы №3 была разработана система управления библиотекой на базе Django и Django REST Framework. В данном документе представлено подробное описание структуры проекта и всех реализованных компонентов.

## Структура проекта

### Корневая директория

В корне проекта находятся следующие файлы:

- **`manage.py`** - основной файл управления Django проектом, используется для выполнения административных команд (миграции, запуск сервера и т.д.)
- **`requirements.txt`** - файл с перечнем всех необходимых зависимостей проекта (Django, DRF, Djoser, MkDocs)
- **`runserver.bat`** и **`runserver.sh`** - скрипты для запуска сервера на порту 8001
- **`migrate.bat`** и **`migrate.sh`** - скрипты для выполнения миграций базы данных

### Директория `laboratory_work_3/`

В данной директории находятся настройки основного проекта Django:

- **`settings.py`** - файл настроек Django, в котором мы:
  - Подключили приложение `app` в `INSTALLED_APPS`
  - Добавили `rest_framework` и `djoser` для работы с API
  - Настроили пути к шаблонам (`templates`) и статическим файлам (`static`)
  - Настроили Django REST Framework с токен-аутентификацией
  - Настроили Djoser для регистрации и авторизации пользователей
  - Указали URL для входа (`LOGIN_URL = '/login/'`)

- **`urls.py`** - главный файл маршрутизации, который подключает:
  - URL-маршруты приложения `app` через `include('app.urls')`
  - URL-маршруты Djoser для API аутентификации (`/auth/`)
  - Админ-панель Django (`/admin/`)

- **`wsgi.py`** и **`asgi.py`** - файлы для развертывания приложения

### Директория `app/`

Основное приложение проекта, содержащее всю бизнес-логику:

#### `models.py`

В данном файле мы реализовали 5 моделей базы данных согласно заданию:

1. **`ReadingRoom`** (Читальный зал) - модель для хранения информации о читальных залах библиотеки:
   - `number` - уникальный номер зала
   - `name` - название зала
   - `capacity` - вместимость зала (количество людей)
   - `created_at` - дата создания записи

2. **`Reader`** (Читатель) - модель для хранения информации о читателях:
   - `ticket_number` - уникальный номер читательского билета
   - `full_name` - ФИО читателя
   - `passport_number` - номер паспорта
   - `birth_date` - дата рождения
   - `address` - адрес читателя
   - `phone_number` - номер телефона
   - `education` - уровень образования (choices: primary, secondary, higher, degree)
   - `has_degree` - наличие ученой степени (BooleanField)
   - `reading_room` - связь с читальным залом (ForeignKey, может быть NULL)
   - `registration_date` - дата записи в библиотеку
   - `unregistration_date` - дата выписки (может быть NULL)
   - `is_active` - флаг активности читателя
   - Метод `age` - вычисляет возраст читателя на основе даты рождения

3. **`Book`** (Книга) - модель для хранения информации о книгах:
   - `title` - название книги
   - `authors` - автор(ы) книги
   - `publisher` - издательство
   - `publication_year` - год издания
   - `section` - раздел библиотеки
   - `code` - шифр книги (может изменяться при переклассификации)
   - `is_active` - флаг активности книги
   - `created_at` и `updated_at` - временные метки

4. **`BookCopy`** (Экземпляр книги в зале) - модель для хранения информации о количестве экземпляров книги в каждом зале:
   - `book` - связь с книгой (ForeignKey)
   - `reading_room` - связь с читальным залом (ForeignKey)
   - `quantity` - количество экземпляров в данном зале
   - Уникальное ограничение на пару (book, reading_room) - одна книга может быть в одном зале только один раз

5. **`BookAssignment`** (Закрепление книги) - модель для отслеживания закрепления книг за читателями:
   - `book` - связь с книгой (ForeignKey)
   - `reader` - связь с читателем (ForeignKey)
   - `assignment_date` - дата закрепления книги за читателем
   - `return_date` - дата возврата книги (может быть NULL)
   - `is_returned` - флаг возврата книги
   - Метод `days_since_assignment` - вычисляет количество дней с момента закрепления

#### `serializers.py`

В данном файле мы создали сериализаторы для всех моделей с использованием Django REST Framework:

1. **`ReadingRoomSerializer`** - сериализатор для читальных залов:
   - Включает вычисляемые поля: `readers_count` (количество активных читателей) и `total_books_count` (общее количество книг)

2. **`ReaderSerializer`** - сериализатор для читателей:
   - Включает вычисляемые поля: `age`, `reading_room_name`, `active_books_count`

3. **`BookSerializer`** - сериализатор для книг:
   - Включает вычисляемые поля: `total_copies` (общее количество экземпляров во всех залах), `active_assignments_count`

4. **`BookCopySerializer`** - сериализатор для экземпляров книг:
   - Включает поля `book_title` и `reading_room_name` для удобства отображения

5. **`BookAssignmentSerializer`** - сериализатор для закреплений:
   - Включает поля `book_title`, `reader_name`, `reader_ticket`, `days_since_assignment`

#### `views.py`

В данном файле реализованы два типа представлений:

**API Views (ViewSets):**

1. **`ReadingRoomViewSet`** - ViewSet для CRUD операций с читальными залами
2. **`ReaderViewSet`** - ViewSet для читателей с дополнительными действиями:
   - `books` - получение книг конкретного читателя
   - `old_assignments` - читатели со старыми закреплениями (>30 дней)
   - `with_rare_books` - читатели с редкими книгами (≤2 экземпляра)
   - `young_readers` - количество читателей младше 20 лет
   - `education_stats` - статистика по образованию в процентах
3. **`BookViewSet`** - ViewSet для книг
4. **`BookCopyViewSet`** - ViewSet для экземпляров книг
5. **`BookAssignmentViewSet`** - ViewSet для закреплений с действием `return_book`
6. **`LibrarianOperationsViewSet`** - ViewSet для операций библиотекаря:
   - `register_reader` - регистрация нового читателя
   - `unregister_old_readers` - исключение старых читателей
   - `write_off_book` - списание книги
   - `accept_book` - прием книги в фонд
   - `monthly_report` - месячный отчет

**Web Views (функциональные представления):**

Все веб-представления используют декоратор `@login_required` для проверки авторизации:

- `index_view` - главная страница со статистикой
- `reading_rooms_list`, `reading_room_create`, `reading_room_detail`, `reading_room_edit` - управление залами
- `readers_list`, `reader_create`, `reader_detail`, `reader_edit` - управление читателями
- `books_list`, `book_create`, `book_detail`, `book_edit`, `book_delete` - управление книгами
- `book_copy_create` - добавление экземпляров книг в залы
- `assignments_list`, `assignment_create`, `assignment_return` - управление закреплениями
- `librarian_operations`, `librarian_old_readers`, `librarian_monthly_report` - операции библиотекаря
- `query_reader_books`, `query_old_assignments`, `query_rare_books`, `query_young_readers`, `query_education_stats` - специальные запросы

#### `views_auth.py`

Отдельный файл для представлений аутентификации:

- **`login_view`** - страница входа в систему:
  - При GET запросе отображает форму входа
  - При POST запросе проверяет учетные данные и выполняет вход через `django.contrib.auth.login`
  - Создает сессию для веб-интерфейса
  - Автоматически создает токен для API при успешном входе

- **`register_view`** - страница регистрации:
  - При GET запросе отображает форму регистрации
  - При POST запросе создает нового пользователя через `User.objects.create_user`
  - Проверяет совпадение паролей и минимальную длину (8 символов)
  - Автоматически создает токен для API через `Token.objects.get_or_create`

- **`logout_view`** - выход из системы:
  - Выполняет выход через `django.contrib.auth.logout`
  - Перенаправляет на главную страницу

#### `forms.py`

В данном файле мы создали Django формы для всех моделей:

1. **`ReadingRoomForm`** - форма для создания/редактирования читальных залов
2. **`ReaderForm`** - форма для создания/редактирования читателей с полями:
   - Все основные поля читателя
   - Выпадающий список для выбора образования
   - Чекбокс для ученой степени
   - Выпадающий список для выбора читального зала
3. **`BookForm`** - форма для создания/редактирования книг
4. **`BookCopyForm`** - форма для добавления экземпляров книг в залы
5. **`BookAssignmentForm`** - форма для создания закреплений

Все формы используют класс `form-control` для стилизации полей ввода.

#### `urls.py`

Файл маршрутизации приложения, в котором мы определили:

1. **Router для API** - создали `DefaultRouter` и зарегистрировали все ViewSets:
   - `/api/reading-rooms/` - читальные залы
   - `/api/readers/` - читатели
   - `/api/books/` - книги
   - `/api/book-copies/` - экземпляры книг
   - `/api/book-assignments/` - закрепления
   - `/api/librarian-operations/` - операции библиотекаря

2. **Веб-маршруты**:
   - `/` - главная страница
   - `/login/`, `/register/`, `/logout/` - аутентификация
   - `/reading-rooms/` - управление залами
   - `/readers/` - управление читателями
   - `/books/` - управление книгами
   - `/book-copies/create/` - добавление экземпляров
   - `/assignments/` - управление закреплениями
   - `/librarian/` - операции библиотекаря
   - `/queries/` - специальные запросы

#### `admin.py`

В данном файле мы зарегистрировали все модели в админ-панели Django с настройками:

- Для каждой модели указали `list_display` - поля, отображаемые в списке
- Настроили `list_filter` - фильтры для удобной работы
- Добавили `search_fields` - поля для поиска
- Указали `ordering` - порядок сортировки по умолчанию
- Для моделей с временными метками добавили `readonly_fields`

### Директория `templates/`

В данной директории мы разместили все HTML шаблоны проекта.

#### `base.html`

Базовый шаблон, от которого наследуются все остальные шаблоны. В нем мы:

- Определили структуру HTML документа с мета-тегами
- Подключили CSS стили из `static/css/style.css`
- Подключили шрифт Inter из Google Fonts
- Создали навигационную панель (`navbar`) с ссылками на все разделы:
  - Главная, Книги, Читатели, Залы, Закрепления, Операции, API, Админ
  - Условное отображение ссылок на вход/регистрацию или информацию о пользователе и выход
- Создали основной контейнер для контента (`main-content`)
- Добавили блок для отображения сообщений Django (`messages`)
- Определили блок `{% block content %}` для переопределения в дочерних шаблонах
- Создали футер с информацией о проекте

#### `index.html`

Главная страница приложения, которая:

- Отображает приветственный заголовок и подзаголовок
- Показывает статистику библиотеки (если передана в контексте):
  - Количество книг в фонде
  - Количество активных читателей
  - Количество читальных залов
  - Количество активных закреплений
- Содержит карточки с описанием основных разделов системы
- Включает раздел со специальными запросами с ссылками на соответствующие страницы

#### `templates/auth/`

Директория с шаблонами аутентификации:

- **`login.html`** - страница входа:
  - Форма с полями "Имя пользователя" и "Пароль"
  - Кнопки: "Войти", "Регистрация", "На главную"
  - Отображение сообщений об ошибках/успехе
  - Примечание о использовании API endpoint

- **`register.html`** - страница регистрации:
  - Форма с полями: имя пользователя, пароль, подтверждение пароля
  - Подсказки о требованиях к полям
  - Кнопки: "Зарегистрироваться", "Уже есть аккаунт?", "На главную"

#### `templates/books/`

Директория с шаблонами для управления книгами:

- **`list.html`** - список всех книг:
  - Заголовок с кнопкой "Добавить книгу"
  - Форма поиска по названию, автору, шифру
  - Таблица с информацией о книгах (шифр, название, автор, издательство, год, раздел)
  - Ссылки на просмотр и редактирование каждой книги
  - Сообщение "Книги не найдены" если список пуст

- **`form.html`** - форма создания/редактирования книги:
  - Универсальный шаблон для обеих операций
  - Отображает все поля формы с помощью цикла `{% for field in form %}`
  - Показывает ошибки валидации под каждым полем
  - Кнопки "Сохранить" и "Отмена"

- **`detail.html`** - детальная информация о книге:
  - Заголовок с кнопками действий (Редактировать, Списать, Добавить экземпляры)
  - Карточка с полной информацией о книге
  - Таблица экземпляров книги в залах
  - Таблица активных закреплений с подсветкой книг старше 30 дней красным цветом

- **`delete.html`** - страница подтверждения списания книги:
  - Предупреждение о необратимости действия
  - Форма с кнопками "Да, списать" и "Отмена"

#### `templates/readers/`

Директория с шаблонами для управления читателями:

- **`list.html`** - список всех читателей:
  - Заголовок с кнопкой "Зарегистрировать читателя"
  - Форма поиска по ФИО, номеру билета, паспорту
  - Таблица с информацией о читателях
  - Отображение статуса активности цветом (зеленый/красный)
  - Ссылки на просмотр и редактирование

- **`form.html`** - форма создания/редактирования читателя:
  - Все поля модели Reader
  - Выпадающий список для образования
  - Чекбокс для ученой степени
  - Выпадающий список для выбора читального зала

- **`detail.html`** - детальная информация о читателе:
  - Полная информация о читателе в виде карточек
  - Вычисление и отображение возраста
  - Таблица закрепленных книг с подсветкой старых закреплений (>30 дней)
  - Кнопка "Закрепить книгу" с предзаполненным читателем

#### `templates/reading_rooms/`

Директория с шаблонами для управления читальными залами:

- **`list.html`** - список всех залов:
  - Таблица с информацией о залах
  - Отображение количества читателей и книг в каждом зале
  - Ссылки на просмотр и редактирование

- **`form.html`** - форма создания/редактирования зала

- **`detail.html`** - детальная информация о зале:
  - Информация о зале
  - Таблица читателей в зале
  - Таблица книг в зале с количеством экземпляров

#### `templates/assignments/`

Директория с шаблонами для управления закреплениями:

- **`list.html`** - список всех закреплений:
  - Фильтры по статусу (Активные/Возвращенные/Все)
  - Таблица с информацией о закреплениях
  - Кнопка "Вернуть" для активных закреплений

- **`form.html`** - форма создания закрепления:
  - Выбор книги и читателя из выпадающих списков
  - JavaScript для автоматического выбора читателя из URL параметра

- **`return.html`** - страница подтверждения возврата книги:
  - Информация о книге и читателе
  - Форма подтверждения возврата

#### `templates/book_copies/`

- **`form.html`** - форма добавления экземпляров книги в зал:
  - Выбор книги и зала
  - Указание количества экземпляров
  - JavaScript для автоматического выбора книги из URL параметра

#### `templates/librarian/`

Директория с шаблонами для операций библиотекаря:

- **`operations.html`** - главная страница операций:
  - Карточки с описанием доступных операций
  - Ссылки на специальные запросы

- **`unregister_old.html`** - страница исключения старых читателей:
  - Описание операции
  - Предупреждение о необратимости
  - Форма подтверждения

- **`monthly_report.html`** - страница месячного отчета:
  - Форма выбора месяца и года
  - Общая статистика за месяц
  - Таблица статистики по дням
  - Детальная статистика по каждому залу для каждого дня

#### `templates/queries/`

Директория с шаблонами для специальных запросов:

- **`reader_books.html`** - книги конкретного читателя:
  - Таблица всех закрепленных книг
  - Подсветка книг старше 30 дней

- **`old_assignments.html`** - читатели со старыми закреплениями:
  - Таблица читателей, взявших книги более месяца назад

- **`rare_books.html`** - читатели с редкими книгами:
  - Таблица читателей с книгами, количество экземпляров которых ≤2

- **`young_readers.html`** - молодые читатели:
  - Отображение количества читателей младше 20 лет
  - Таблица всех таких читателей с возрастом

- **`education_stats.html`** - статистика по образованию:
  - Карточки с процентным соотношением по каждому уровню образования
  - Общее количество активных читателей

### Директория `static/`

В данной директории размещены статические файлы проекта.

#### `static/css/style.css`

Файл со всеми стилями приложения. Мы реализовали:

1. **Общие стили**:
   - Сброс стилей браузера (`* { margin: 0; padding: 0; }`)
   - CSS переменные для цветов и размеров (`:root`)
   - Базовые стили для body и контейнеров

2. **Навигация** (`navbar`):
   - Градиентный фон (от синего к темно-синему)
   - Липкая навигация (`position: sticky`)
   - Гибкое расположение элементов
   - Эффекты при наведении

3. **Карточки и формы**:
   - Стили для карточек функций (`feature-card`)
   - Стили для форм (`form-container`, `form-group`, `form-control`)
   - Валидация полей с подсветкой при фокусе
   - Стили для кнопок различных типов (primary, secondary, danger)

4. **Таблицы**:
   - Стили для таблиц (`table-container`, `table`)
   - Чередование цветов строк
   - Эффект при наведении

5. **Статистика**:
   - Сетка для карточек статистики (`stats-grid`, `stat-card`)
   - Крупные иконки и значения

6. **Адаптивность**:
   - Медиа-запросы для мобильных устройств (`@media (max-width: 768px)`)
   - Адаптация навигации и сеток под маленькие экраны

### Директория `docs/`

Директория с документацией проекта в формате Markdown для MkDocs:

- **`index.md`** - главная страница документации с описанием проекта и быстрым стартом
- **`models.md`** - подробное описание всех моделей базы данных
- **`queries.md`** - описание специальных запросов библиотекаря
- **`web-interface.md`** - описание веб-интерфейса
- **`api/`** - поддиректория с документацией всех API endpoints:
  - `authentication.md` - аутентификация через Djoser
  - `reading-rooms.md` - API для читальных залов
  - `readers.md` - API для читателей
  - `books.md` - API для книг
  - `book-copies.md` - API для экземпляров книг
  - `book-assignments.md` - API для закреплений
  - `librarian-operations.md` - API для операций библиотекаря

## Реализованный функционал

### Модели базы данных

Все модели реализованы согласно заданию с учетом всех требований:

- Книги могут перерегистрироваться в другом зале через модель `BookCopy`
- Шифр книги может изменяться через редактирование поля `code`
- Номер читательского билета может изменяться через редактирование поля `ticket_number`
- Читатели могут переписаться в другой зал через редактирование поля `reading_room`
- Читатели могут записываться и выписываться через поля `registration_date`, `unregistration_date`, `is_active`

### API Endpoints

Реализованы все необходимые endpoints через Django REST Framework:

- CRUD операции для всех моделей
- Поиск и фильтрация данных
- Пагинация результатов (20 элементов на страницу)
- Специальные endpoints для запросов библиотекаря
- Операции библиотекаря (регистрация, исключение, списание, прием книг)
- Месячный отчет с детальной статистикой

### Веб-интерфейс

Создан полнофункциональный веб-интерфейс без использования JavaScript:

- Все операции выполняются через HTML формы
- Валидация данных на стороне сервера
- Сообщения об успехе/ошибках через Django messages
- Адаптивный дизайн для всех устройств
- Удобная навигация между разделами

### Аутентификация

Реализована двойная система аутентификации:

- **Для веб-интерфейса**: Django сессии через собственные HTML формы (`/login/`, `/register/`)
- **Для API**: Токены через Djoser (`/auth/token/login/`, `/auth/users/`)

Оба способа используют одну базу пользователей Django.

### Специальные запросы

Реализованы все 5 запросов из задания:

1. Книги закрепленные за читателем - через страницу читателя или API endpoint
2. Читатели со старыми закреплениями (>30 дней) - отдельная страница и API
3. Читатели с редкими книгами (≤2 экземпляра) - отдельная страница и API
4. Количество молодых читателей (<20 лет) - отдельная страница и API
5. Статистика по образованию в процентах - отдельная страница и API

### Операции библиотекаря

Реализованы все 4 операции:

1. Регистрация нового читателя - через веб-форму или API
2. Исключение старых читателей - отдельная страница подтверждения и API
3. Списание книги - страница подтверждения и API
4. Прием книги в фонд - веб-формы или API с автоматическим созданием экземпляров

### Месячный отчет

Реализован полнофункциональный месячный отчет:

- Выбор месяца и года через форму
- Статистика по каждому дню месяца:
  - Количество книг в фонде на дату
  - Количество активных читателей на дату
  - Количество новых читателей в день
- Детальная статистика по каждому залу для каждого дня:
  - Количество книг в зале
  - Количество читателей в зале
  - Количество новых читателей в зале

## Заключение

В результате выполнения лабораторной работы была создана полнофункциональная система управления библиотекой, которая включает:

- 5 моделей базы данных с полной реализацией всех требований задания
- RESTful API через Django REST Framework с сериализацией данных
- Аутентификацию через Djoser для API и Django сессии для веб-интерфейса
- Полнофункциональный веб-интерфейс с HTML формами
- Все специальные запросы и операции библиотекаря
- Месячный отчет с детальной статистикой
- Полную документацию через MkDocs

Система готова к использованию и может быть развернута на сервере для реальной эксплуатации.
